name: Publish PR preview

on:
  pull_request:
    # To manage 'surge-preview' action teardown, add default event types + closed event type
    types: [opened, synchronize, reopened, closed]
    branches:
      - master
    paths:
      - ".github/actions/build-setup/**/*"
      - ".github/workflows/publish-pr-preview.yml"
      - "resources/**/*"
      - "antora-playbook.yml"
      - "build-preview.bash"
      - "package.json"
      - "package-lock.json"

permissions:
  # surge-preview creates or updates PR comments about the deployment status
  pull-requests: write

jobs:
  build_preview:
    runs-on: ubuntu-20.04
    env:
      BONITA_BRANCH: "2021.2"
      BCD_BRANCH: "3.5"
      CLOUD_BRANCH: "master"
      LABS_BRANCH: "master"
      TOOLKIT_BRANCH: "1.0"
    steps:
      - uses: process-analytics/github-actions-playground/.github/actions/surge-preview-tools/@master
        id: surge-preview-tools
        with:
          surge-token: ${{ secrets.SURGE_TOKEN_DOC }}
      - name: Checkout
        uses: actions/checkout@v3
        if: github.event.action != 'closed'
      - name: Build Setup
        uses: ./.github/actions/build-setup
        if: github.event.action != 'closed'
      - name: Build Preview
        if: github.event.action != 'closed'
        run: >
          ./build-preview.bash --use-multi-repositories
          --component-with-branches bonita:"${{ env.BONITA_BRANCH }}"
          --component-with-branches bcd:"${{ env.BCD_BRANCH }}"
          --component-with-branches cloud:"${{ env.CLOUD_BRANCH }}"
          --component-with-branches labs:"${{ env.LABS_BRANCH }}"
          --component-with-branches test-toolkit:"${{ env.TOOLKIT_BRANCH }}"
          --pr "${{ github.event.pull_request.number }}"
          --site-url "${{ steps.surge-preview-tools.outputs.preview-url }}"
      - name: Publish preview
        uses: afc163/surge-preview@v1
        if: steps.surge-preview-tools.outputs.can-run-surge-command == 'true'
        with:
          surge_token: ${{ secrets.SURGE_TOKEN_DOC }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          dist: build/site
          failOnError: true
          teardown: true
          build: |
            ls -lh build/site
